# 利用爬虫爬取bilibili视频
## author：Qs
## 概述
### 项目组成
主项目：bilibili视频爬虫 <br>
子项目：利用爬虫爬取网站图片，可以用来爬取bilibili封面<br>
### 项目功能
利用爬虫获取bilibili视频文件与信息，利用爬虫爬取网站图片

### 目前开发状况
bilibili视频爬取已经比较成熟，但是仍然存在一些缺陷，目前尚不清楚有无解决方法
图片爬取仍然还是最开始的样子，基本没有发展
关于程序是怎么执行的，在“项目流程框图.png”里面介绍过，主要介绍的还是bilibili视频爬取的流程，毕竟这个项目主要就是哔哩哔哩视频爬取
在本文档中，介绍的重心也将放在bilibili爬虫项目上

## bilibili爬虫项目

### 一、快速上手
本项目相比于它的前身来讲，最大的优点就是用户友好
#### 1)环境配置
   基本python环境配置好后安装以下库
    
    from json import JSONDecodeError
    from lxml import etree
    import json
    from bs4 import BeautifulSoup
    from moviepy.editor import *
    import re
    import requests
    from time import sleep
项目结构
见“项目结构.png”
在bilibili_project下新建
- audio_file文件夹(用来存储bilibili的音频文件)
- video_file文件夹(用来存储bilibili的画面文件，没有声音)
- video_result文件夹(用来存储bilibili的完整视频文件)
- html_file文件夹(用来存储指定模式下获得的html文件，或者获取视频失败后的html文件)
- picture文件夹(用于存储子项目获取的图片)
<br>
注:在项目中，代码会寻找这些文件夹以存储相关文件，如果没找到会报错
#### 2)运行前的准备
1.配置user_config.py文件<br>
user_config.py文件中，与爬取视频相关的用户变量分为两组<br>
##### 第一组变量
video_config字典，标准格式如下图

    video_config={
    ID号(推荐BV号): [模式，集数],
    url: [模式，集数],
    关键词: [模式，select_enable],
    }
    # 模式:mode ==-1:完整视频 -2:获取音频 -3:仅获取html -4:仅获取画面 -5:自定义程序
    # 集数:指明该url或者ID号下需要连续的几集(合集视频，分集视频，番剧电影)

    # select_enable 关键词提交给bilibili检索后，会返回许多相关的项目
    # 此时 如果此关键词的select_enable为1的话，程序将进入检索交互界面，将搜索得到的视频标题打印到运行窗口
    # 若 如果此关键词的select_enable为0的话，程序将不会进入检索交互界面，搜索得到的视频，按照bilibili排列的顺序，选择前default_number_of_videos(第二组用户变量中的)个进行爬取
    
    # 合法的输入
    url:以“http://”,“https://”,"www."(w大小写均可)开头且含有视频ID(以AV,BV,ss,ep(大小写均可)开头的字母与数字组合) 。程序判定时，若ID中有AV/BV判断为非番剧电影，若有ss/ep判断是番剧电影
        其中 非番剧电影的网址为”https://www.bilibili.com/video/“+AVxxxxx或BVxxxxxx 番剧电影的网址是“https://www.bilibili.com/bangumi/play/”+ssxxxx或epxxxxx
        因此 输入url为“https://www.bilibili.com/video/ss12345”或“https://www.bilibili.com/bangumi/play/BV12345678”虽然不会被判定成非法输入，但最后可能得不到你想要的目标，甚至不能得到目标(ID不存在时会出现)
    ID号:以AV,BV,ss,ep(大小写均可)开头的字母与数字组合 (不存在的ID最后不能得到视频，画面或音频文件，程序会告诉你获取失败了，并保存下相应网址请求得到的.html文件)
        推荐使用BV号，测试充分，功能稳定；ss与ep号检索选集存在问题；AV号因为现在bilibili已经未使用而测试较少
    关键词:不以“http://”,“https://”,"www."(w大小写均不行)开头且不是“AV,BV,ss,ep+只有数字或字母”

    # 不合法的输入情况处理
        url中没有bilibili视频ID(一般视频为AV、BV号，番剧电影为ss、ep号),程序自动判断，予以丢弃
        ID号：不是数字与字母组合，含有特殊字符的，程序自动判断，归类为关键词
        空字符串("":[-1,1])程序予以丢弃
        集数超限：若输入集数变量超过视频最大集数，程序爬取全集
        
##### 第二组变量
文件user_config.py中注释“debug_setting_variables_begin”与“debug_setting_variables_end”中间的全局变量
主要负责video_config字典中 每个键对应的“值列表”缺项的默认认定(见下图) <br>
我们从上面也已经知道，模式变量一定小于0，集数变量一定大于0，select_enable只能为0或1，因此，在两项中缺一项时，我们很容易通过留下的项的正负来推断它的实际意义
    
    # 缺项的默认认定(想偷懒可以直接把列表缺项，去配置全局的默认变量就行)
    # url与ID号
    # 1.全空例：ID:[]——模式集数全默认 
    # 2.半空例：ID:[-1]——指定模式为-1，默认集数
    # 3.半空例：ID:[2]——默认模式，指定集数为2
    # 4.全满例：直接认定
    
    # 关键词
    # 1.全空例：关键词:[]——模式与select_enable全默认
    # 2.半空例：关键词:[-1]——指定模式为-1，默认select_enable
    # 3.半空例：关键词:[0]——默认模式，指定select_enable为0
    # 4.全满例：直接认定
    
    当“模式”默认时
        mode=default_mode
    当“集数”默认时    
        若default_select_episode_enable==0，则会进入选集交互界面，在界面内选集
        若default_select_episode_enable==1，不会进入选集交互界面，所有视频选取max{总集数,default_episode_num}集
    当select_enable默认时
        若default_select_enable == 0 默认直接取检索结果前default_number_of_videos位，而不是在检索交互界面选择
        若default_select_enable == 1 则在交互界面

    对于ID或url给出的内容，当“模式”，“集数”不默认时，按照给出的模式与集数(<总集数，大于则取总集数)爬取
    对于关键词给出的内容，当“模式”，select_enable均不默认时，选取检索结果后(自动选择或者在交互界面选)，再选集(自动选择或者在交互界面选)
    # 示例

    video_config = {
    "https://jw.hitsz.edu.cn": [-1, 3],  # 不合法的输入 非bilibili网站网址
    "https://www.bilibili.com": [-1, 3],  # 不合法的输入，bilibili网站网址但非bilibili视频网址
    "https://www.bilibili.com/video/BV12F411u7my/": [-1, 1],  # 网址检索
    "BV1aj411w7qj": [-1, 1],  # BV号检索
    "ss36429":[-1,1], #ss号检索
    "ep693247":[-1:1],#ep号检索
    "https://www.bilibili.com/bangumi/play/ep827835?spm_id_from=333.337.0.0":[-1,]
    "https://www.bilibili.com/video/BV1J84y1a7i1/?spm_id_from=333.999.0.0": [-2],  # 缺项用默认补全
    "想い出がいっぱい": [-1, 0],  # 关键词检索非交互模式
    "感情的摩天楼": [-1, 1],  # 关键词检索交互模式
    "星之梦": [-2, 1] # 关键词检索交互模式
    }
##### 好像少了什么
<p>
通过上述讲解，如果你足够细心，应该可以发现我们在上面的介绍中遗漏了两个变量<br>
一个变量是main_debug_setting，这个变量我不讲你也应该知道，去main.py(原谅我用c语言的方法来命名.py)里面看看就知道了, main_debug_setting=0:只获取视频，1:只获取图片，2:都要，3与其他：debug程序<br></p>
<p>另一个变量是display_num，这个变量在检索交互中有大作用。由于在向bilibili提交关键词，网站返回的一页检索结果是42个左右，
如果尽数打印出来，交互界面会显得很庞大。而且交互界面还是在运行窗口里面，这样就给选择造成很大干扰，用户体验也不好，况且排序靠后的检索结果大概率也是相关性很低，我们不想要的。
因此，这个变量限制了交互界面最多打印的项目数(从前往后取display_num个检索结果来展示)。<br>
还有两个变量是audio_file_type与video_file_type，这两个变量标明获取的音频/画面/视频文件格式，必须是moviepy库支持的格式<br>

</p>
<p>
当然, video_config字典中每个关键词的检索结果都不一样，也不能一概而论检索结果排序靠后的都是我们不想要的，
因此在检索交互界面，提供了“display all”命令，可以不论display_num为何值而将该关键词的检索结果尽数列出。
</p>

#### 3)关于交互界面
目前的交互界面有两个，检索交互界面和选集交互界面
##### 检索交互界面
<p>
当全局变量display_num>=0时，交互界面默认为不完全打印窗口<br>
此时，可以输入属于区间[1，展示出的最大序号]的数字，表示你想选择哪个结果<br>
也可以输入exit退出选择<br>
也可以输入delete，删除之前选择的结果，重新选择<br>
也可以输入display all，程序将重新开始此次选择，打印所有检索结果，并且删除输入display all之前的选择结果<br>
除此之外，任何输入，包括不属于属于区间[1，展示出的最大序号]的数字，将被视为非法字符，输入非法字符程序会给出提示，并且程序会忽略所有非法字符，不会对选择造成任何影响<br>
</p>
<p>
若全局变量display_num=-1时，或者在不完全打印状态下输入display all命令，将进入完全打印窗口
此时，可以输入属于区间[1，展示出的最大序号]的数字，表示你想选择哪个结果<br>
也可以输入exit退出选择<br>
也可以输入delete，删除之前选择的结果，重新选择<br>
除此之外，任何输入，包括不属于属于区间[1，展示出的最大序号]的数字，将被视为非法字符，输入非法字符程序会给出提示，并且程序会忽略所有非法字符，不会对选择造成任何影响<br>
</p>

##### 选集交互界面
<p>
我们知道，bilibili的检索结果不仅仅包含普通视频，也包含官方番剧和电影(还有广告)<br>
好在广告的问题在程序里面已经解决了<br>
</p>
<p>
无论select_enable是何值，都不会影响进入选集交互界面，select_enable决定的是进入检索交互界面<br>
进入选集交互界面的唯一条件就是从检索结果中选择了：分集视频，合集视频或番剧电影(视频分类见bilibili视频类型介绍一节)
</p>
<p>
在选集交互界面，可以输入属于区间[1，展示出最大集数]的数字，表示你想选择哪一集<br>
也可以输入exit退出选择<br>
也可以输入delete，删除之前选择的结果，重新选择<br>
也可以输入select all，表示选择全集或者完整的合集(不一定是打印出的部分,而是完整的全集)，并退出选集交互界面<br>
对于合集视频，若合集中视频过多，则交互界面只会列出一部分视频，此时，输入display all可以打印完整的合集， 同时删除合集中之前所选的项目
</p>
<p>
除此之外，任何输入，包括不属于属于区间[1，展示出最大集数]的数字，将被视为非法字符，输入非法字符程序会给出提示，并且程序会忽略所有非法字符，不会对选择造成任何影响<br>
</p>

### 二、bilibili介绍
#### 1)bilibili视频类型介绍
<b>按照视频选集结构可以分为</b>
##### 1.普通视频
就是平台最多的那一种视频，为用户自传，一个BV号对应一个视频，与一个视频描述
(一个视频描述：指一个简介，一个评论区，一个总点赞收藏投币转发数，一个弹幕池的集合)
    
    url格式= "https://www.bilibili.com/" + BV号
##### 2.分集视频
此类视频也是用户上传，但是一个BV号对应多个视频
这样的一系列视频均挂在一个BV号之下，在bilibili上也只有一个视频描述集合
    
    url格式= "https://www.bilibili.com/" + BV号+"/？p=" + episode_id(集序号)
##### 3.合集视频
此类视频为用户上传，也是多个视频，但和分集视频不同
合集中的每一个视频对应不同的BV号，分别有不同的视频描述集合，但是属于一个视频合集，类似于一个收藏夹
    
    url格式= "https://www.bilibili.com/" + BV号
##### 4.番剧电影
此类视频为bilibili官方发布，不采用BV号编码，而采用ss号和ep号编码
ss号指向对应番剧电影系列，访问该ss码得到的时该系列的第一集
例如
    
    ss36429：《Re：从零开始的异世界生活 第二季 后半》
    ss33802：《Re：从零开始的异世界生活 第二季 前半》
    ss39288：《星之梦～雪圈球～》
    ss43164：《孤独摇滚！》

ep号指向番剧电影的具体某一集
例如

    ep693247：《孤独摇滚！》第一集
    ep693248：《孤独摇滚！》第二集
    ep693249：《孤独摇滚！》第三集 

    ep703035：《孤独摇滚！》第四集 
    ep703036：《孤独摇滚！》第五集
    ep703037：《孤独摇滚！》第六集 

    ep706287：《孤独摇滚！》第七集
    ep706288：《孤独摇滚！》第八集
    ep706289：《孤独摇滚！》第九集

    ep718236：《孤独摇滚！》第十集
    ep718237：《孤独摇滚！》第十一集
    ep718238：《孤独摇滚！》第十二集
    
    ep827835：《不时用俄语说真心话的邻桌艾莉同学》第一集
    ep827836：《不时用俄语说真心话的邻桌艾莉同学》第二集          
    ep827837：《不时用俄语说真心话的邻桌艾莉同学》第三集

    ep829607：《不时用俄语说真心话的邻桌艾莉同学》第四集
    ep829608：《不时用俄语说真心话的邻桌艾莉同学》第五集
    ep829609：《不时用俄语说真心话的邻桌艾莉同学》第六集

    ep833028：《不时用俄语说真心话的邻桌艾莉同学》第七集
    ep833029：《不时用俄语说真心话的邻桌艾莉同学》第八集
    ep833030：《不时用俄语说真心话的邻桌艾莉同学》第九集

    ep835998：《不时用俄语说真心话的邻桌艾莉同学》第十集
    ep835999：《不时用俄语说真心话的邻桌艾莉同学》第十一集
    ep836000：《不时用俄语说真心话的邻桌艾莉同学》第十二集    

通过观察ep号的规律，很明显，大部分番剧连续三集的ep号是连续的，推测可能和番剧的送审机制有关(三集一个周期)
这样的不连续也给程序设计中，番剧电影的集数索引带来了不小的麻烦，与分集视频不同，若采用“第一集地址+集数序号”的方法索引每集视频，会出现错误，这个问题在代码里面还没有解决，
因此，当需要爬取番剧时，列出所有集数的ep号或者url，并且设置每个ep号或url的集数为1，<b>不要用ep/ss/url：[模式，集数>1]的方式配置user_config</b>

ss号与ep号的url格式均为

    url格式= "https://www.bilibili.com/bangumi/play/" + ss号/ep号

<b>按照视频权限可以分为</b>

##### 1.特殊权限视频(程序暂不支持此类视频爬取)
特殊权限视频指的是大会员专享与充电粉丝专享的一类视频，向bilibili请求数据时，
由于没有提供相应的大会员或者充电粉丝账号， 因此，bilibili将爬虫视为用游客身份访问的用户
对于大会员视频，可以获取预览版本，充电视频则不能获取，程序在爬取时会对此予以告知

##### 2.特殊画质
bilibili官方的视频画质分为
"HDR 真彩","4k 高清","高清1080P+(高码率)","高清 1080P", "高清 720P", "清晰 480P", "流畅 360P"(readme/纪录片：绿色星球画质栏.png)
前两者大多存在于官方发布的纪录片里，后面的常见于普通视频
对于特殊画质，由于bilibili网页版提供了试看功能，因此，在向bilibili请求数据时，是可以得到最高画质的完整视频的(对应测试：程序能够爬取《不时用俄语说真心话的邻桌艾莉同学》第一集1080 p+画质)
bilibili的画质试看限制貌似是在网页前端加上一个定时器，时间结束自动切回原有画质，但每一种画质对应的视频url已经暴露在了网页html源码之中(也许是bilibili网页版的一个bug)


<b>除此之外，bilibili还有其他类型的资源</b>

##### 1.番剧电影介绍(程序暂不支持此类信息爬取)
通过md码编码
    
    url格式= "https://www.bilibili.com/bangumi/media/" + md码
    例如：md28234980：《星之梦～雪圈球～》
##### 2.专栏(程序暂不支持此类信息爬取)
用cv号编码
    
    url格式= "https://www.bilibili.com/read/" + cv码
    例如：cv35246728：《东方Project1001弹》
##### 3.其他(程序暂不支持此类信息爬取)
    有空再来补充
#### 2)bilibili api介绍
##### 1. search
    target_url = "https://search.bilibili.com/" + 分区 +"?keyword=" + keyword + "&page=" + page_num
<p>
search.bilibili.com调用bilibili搜索api，keyword为检索词，page为检索页页码(readme/搜索分区.png,readme/搜索页码.png)<br>
其中分区可以为 all：综合, video：视频, bangumi：番剧, pgc：影视, live：直播, article：专栏, upuser：用户
</p>
<p>
通过request请求对应url返回html文件(返回的html文件示例在readme/.html文件内)
本程序中，返回的html分类是“综合”，页码是第一页，html文件与视频相关的部分有以下两类(搜索页面示例.png)
</p>
<p>
番剧电影与用户上传视频。其中，用户上传视频包含分集视频，合集视频与普通视频
</p>
关于bilibili的搜索api的详细介绍，详见"https://www.bilibili.com/read/cv7179492/"

##### 2.其他api
关于bilibili的其他api的介绍，可见csdn专栏："https://blog.csdn.net/z814561527/article/details/123939509"

### 三、程序的底层实现
#### 1)程序的处理逻辑
第一种情况：在user_config中用ID或url的格式给出
##### 1.普通视频
由于普通视频不分集，也不存在于合集之中，因此对于它的处理最为简单
选集默认为第一集，总集数为1
##### 2.番剧电影
番剧电影默认分集，集数由程序读取后存储在video_list的总集数变量中(变量格式见：变量格式介绍)
若在user_config中用视频ID号(BV,AV,ss,ep)给出，且指定集数，则不会进入选集交互界面<br>
如没有指定集数 且 default_select_episode_enable=0 则默认选择前default_episode_num集，若总集数小于default_episode_num，则选择全集<br>
如没有指定集数 且 default_select_episode_enable=1 则会进入选集交互界面，根据程序提示选集<br>
对于以ss号给出的番剧电影，程序为了便于选集，会将其替换为对应番剧的第一集ep号<br>

##### 3.分集视频
分集视频，程序会自动读取总集数，后存储在video_list的总集数变量中(变量格式见：变量格式介绍)
其他处理流程与番剧电影一致

##### 4.合集视频
合集视频，程序会自动读取总集数，与合集中每一集的BV号
其他处理流程与番剧电影一致

第二种情况：在user_config中用关键词的格式给出
##### 1.调用bilibili的api发起搜索（keywords_to_selected_list函数）
默认为综合分区，页码为第一页，后期可能加入翻页选项
##### 2.在bilibili返回的html文件中提取有效信息（keywords_to_selected_list函数）
<p>
由于我实在是不想看bilibili返回的那个又臭又长还一堆报错的html文件了
因此，大部分html文件的解析没有用beautifulsoup库或者lxml库，而采用了简单粗暴的正则表达式匹配的方法
提取的视频信息存放于keywords_to_selected_list函数的内部变量info_list中
</p>
<p>
特别补充，视频合集类似于一个收藏夹，里面的视频各有不同的BV号，因此，视频合集中的各个视频并无逻辑上的上下集关系。
也就是说，分集视频或者番剧电影在检索页面返回的地址为第一集的地址，而合集视频返回的则是这个视频本身的地址，这个视频在它所属的合集中不一定是第一集。
所以，对于合集视频，info_list补充了该视频在合集中对应的集数序号（“这是第...集”） 。
而对于普通视频，番剧电影，分集视频，该变量为1，也就是认为通过检索页面搜索得到的视频为该系列的第一集。
</p>

###### 3.检索交互界面
在此界面完成对搜索结果的选择，但没有指定每个视频选择的集数
###### 4.选集交互界面
在此界面完成对已经选择的检索结果的集数选择

##### 后续流程
无论user_config中以什么方式给出视频的信息，执行完上述第一种情况与第二种情况后，格式都一样了
为video_list格式的变量(变量格式见：变量格式介绍)
这时，程序会对所有的集数进行检查，如果有相同BV号的视频则予以合并(逻辑有待补充)
最后，video_list交给core.py中的函数(爬虫项目的核心代码)，完成对每一集的爬取

#### 2)重要变量格式
##### 1.全局变量

    用户接口，支持BV与AV号,ss号与ep号，bilibili视频网址，视频关键词检索
    # BV号: [模式，集数]
    # url: [模式，集数]
    # 关键词：[模式,select_enable]
    # 缺项默认处理逻辑已在上文写出
    模式 mode ==-1:完整视频 -2:获取音频 -3:仅获取html -4:仅获取画面 -5:自定义(core.py的core_function中)
    user_config={
    BV号: [模式，集数],
    AV号: [模式，集数],
    ss号: [模式，集数],
    ep号: [模式，集数],
    url: [模式，集数],
    关键词：[模式,select_enable]
    }

    程序内核接口格式
    standard_list=[
    [视频1id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],
    [视频2id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],
    [视频2id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],...]
    # 视频类型标签(0:一般视频(动画综合也包含在其中)，1:番剧电影，2：分集视频，3:合集视频)

##### 2.局部变量   
1.keywords_to_selected_list函数
    
    # 储存检索结果的列表
    info_list=[
    [ID号,标题，集数，这是第..集，视频类型标签],
    [ID号,标题，集数，这是第..集，视频类型标签],
    [ID号,标题，集数，这是第..集，视频类型标签].....]
    # 视频类型标签(0:一般视频(动画综合也包含在其中)，1:番剧电影，2：分集视频，3:合集视频)
2.main函数
    
    ID_standard_list=[
    [视频1id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],
    [视频2id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],
    [视频2id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],...]
    # 视频类型标签(0:一般视频(动画综合也包含在其中)，1:番剧电影，2：分集视频，3:合集视频)

    keyword_middle_list=[
    [key(关键词),select_enable,mode],
    [key(关键词),select_enable,mode],
    [key(关键词),select_enable,mode],...]
    
    keyword_standard_list=[
    [视频1id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],
    [视频2id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],
    [视频2id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],...]
    # 视频类型标签(0:一般视频(动画综合也包含在其中)，1:番剧电影，2：分集视频，3:合集视频)

    video_list=[
    [视频1id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],
    [视频2id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],
    [视频2id(BV AV与EP),选择集数列表[], 总集数，视频标题，视频类型标签,模式],...]
    # 视频类型标签(0:一般视频(动画综合也包含在其中)，1:番剧电影，2：分集视频，3:合集视频)

### 三、后期开发规划
1.重构代码，删除冗余部分<br>
2.用merge函数排除重复部分<br>
3.提取专栏，番剧电影描述，简介等文本资料<br>
4.将请求bilibili的数据的代码部分封装成一个库，以便复用<br>
5.爬虫加入模拟登陆功能，尝试爬取大会员视频<br>